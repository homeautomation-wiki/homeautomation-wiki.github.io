<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An intensive how-to guide for building (almost) production-ready K3S Homelab with a couple of Raspberry PIs."><meta name=author content="Armagan Karatosun"><title>Kubernetes Homelab with K3S and Raspberry Pi 4 | HomeAutomation.wiki</title><link rel=apple-touch-icon sizes=180x180 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><meta property="og:title" content="Kubernetes Homelab with K3S and Raspberry Pi 4"><meta property="og:description" content="An intensive how-to guide for building (almost) production-ready K3S Homelab with a couple of Raspberry PIs."><meta property="og:type" content="article"><meta property="og:url" content="https://homeautomation.wiki/post/k3s-the-hard-way/"><meta property="og:image" content="https://homeautomation.wiki/favicon.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-07-19T00:00:00+00:00"><meta property="article:modified_time" content="2021-07-19T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://homeautomation.wiki/favicon.png"><meta name=twitter:title content="Kubernetes Homelab with K3S and Raspberry Pi 4"><meta name=twitter:description content="An intensive how-to guide for building (almost) production-ready K3S Homelab with a couple of Raspberry PIs."><link rel=preload as=font href=/fonts/Metropolis.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/LiberationSans.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/LiberationSans-Bold.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/LiberationSans-BoldItalic.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/LiberationSans-Italic.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/LiberationMono.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/DroidSans.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload as=font href=/fonts/GeekblogIcons.woff2 type=font/woff2 crossorigin=anonymous><link rel=preload href=/main-342b625c73.min.css as=style><link rel=stylesheet href=/main-342b625c73.min.css media=all><link rel=preload href=/mobile-14fbbb71d2.min.css as=style><link rel=stylesheet href=/mobile-14fbbb71d2.min.css media="screen and (max-width: 45rem)"><link rel=preload href=/print-86167e859a.min.css as=style><link rel=stylesheet href=/print-86167e859a.min.css media=print><link rel=preload href=/custom.css as=style><link rel=stylesheet href=/custom.css media=all><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"post","name":"Kubernetes Homelab with K3S and Raspberry Pi 4","headline":"Kubernetes Homelab with K3S and Raspberry Pi 4","alternativeHeadline":"","description":"Building A Kubernetes Homelab with K3S and Raspberry Pi 4: The Hard Way     K3S is one of the best solutions available if you want to deploy your own Kubernetes cluster inside your homelab to play with, or just for learning purposes. And it is really easy to get started with a couple of (actually, you only need one) Raspberry PIs. But \u0026ldquo;What is K3S?\u0026rdquo;, you might ask.","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/homeautomation.wiki\/post\/k3s-the-hard-way\/"},"author":[{"@type":"Person","name":"Armagan Karatosun"}],"copyrightHolder":"HomeAutomation.wiki","copyrightYear":"2021","dateCreated":"2021-07-19T00:00:00.00Z","datePublished":"2021-07-19T00:00:00.00Z","dateModified":"2021-07-19T00:00:00.00Z","publisher":{"@type":"Organization","name":"HomeAutomation.wiki","url":"https://homeautomation.wiki","logo":{"@type":"ImageObject","url":"https:\/\/homeautomation.wiki\/logo.png","width":"32","height":"32"}},"url":"https:\/\/homeautomation.wiki\/post\/k3s-the-hard-way\/","wordCount":"3064","genre":["kubernetes","raspberry-pi","home-assistant"]}</script></head><body><svg style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><symbol viewBox="-7.27 -7.27 46.55 46.55" id="arrow_back" xmlns="http://www.w3.org/2000/svg"><path d="M31.999 14.035v3.93H7.673l11.134 11.228L16 32 .001 16.001 16 .002l2.807 2.807L7.673 14.037h24.326z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="arrow_left" xmlns="http://www.w3.org/2000/svg"><path d="M7.954 17.965v5.988L.001 16l7.953-7.953v5.988H32v3.93H7.954z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="arrow_right" xmlns="http://www.w3.org/2000/svg"><path d="M24.046 14.035V8.047L31.999 16l-7.953 7.953v-5.988H0v-3.93h24.046z"/></symbol><symbol viewBox="-7.27 -7.27 42.55 42.55" id="bitbucket" xmlns="http://www.w3.org/2000/svg"><path d="M15.905 13.355c.189 1.444-1.564 2.578-2.784 1.839-1.375-.602-1.375-2.784-.034-3.403 1.151-.705 2.818.223 2.818 1.564zm1.907-.361c-.309-2.44-3.076-4.056-5.328-3.042-1.426.636-2.389 2.148-2.32 3.747.086 2.097 2.08 3.815 4.176 3.626s3.729-2.234 3.472-4.331zm4.108-9.315c-.756-.997-2.045-1.169-3.179-1.358-3.214-.516-6.513-.533-9.727.034-1.066.172-2.269.361-2.939 1.323 1.1 1.031 2.664 1.186 4.073 1.358 2.544.327 5.156.344 7.699.017 1.426-.172 3.008-.309 4.073-1.375zm.979 17.788c-.481 1.684-.206 3.953-1.994 4.932-3.076 1.701-6.806 1.89-10.191 1.289-1.787-.327-3.884-.894-4.864-2.578-.43-1.65-.705-3.334-.98-5.018l.103-.275.309-.155c5.121 3.386 12.288 3.386 17.427.0.808.241.206 1.22.189 1.805zM26.01 4.951c-.584 3.764-1.255 7.51-1.908 11.257-.189 1.1-1.255 1.719-2.148 2.183-3.214 1.615-6.96 1.89-10.483 1.512-2.389-.258-4.829-.894-6.771-2.389-.911-.705-.911-1.908-1.083-2.922-.602-3.523-1.289-7.046-1.719-10.604.206-1.547 1.942-2.217 3.231-2.698C6.848.654 8.686.362 10.508.19c3.884-.378 7.854-.241 11.618.859 1.341.395 2.784.945 3.695 2.097.412.533.275 1.203.189 1.805z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="bookmarks" xmlns="http://www.w3.org/2000/svg"><path d="M20.357 5.856q1.157.0 2.043.851t.885 2.008v23.284l-10.212-4.357-10.144 4.357V8.715q0-1.157.885-2.008t2.042-.851h14.502zm5.787 18.859V5.856q0-1.157-.851-2.042t-2.008-.885H8.715q0-1.157.885-2.042t2.043-.885h14.502q1.157.0 2.043.885t.885 2.042v23.216z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="clear" xmlns="http://www.w3.org/2000/svg"><path d="M32 3.222 19.222 16 32 28.778l-3.221 3.221-12.778-12.778L3.223 31.999.002 28.778 12.78 16 .002 3.222 3.223.001l12.778 12.778L28.779.001z"/></symbol><symbol viewBox="-7.27 -7.27 42.55 42.55" id="code" xmlns="http://www.w3.org/2000/svg"><path d="M9.917 24.5a1.75 1.75.0 10-3.501.001 1.75 1.75.0 003.501-.001zm0-21a1.75 1.75.0 10-3.501.001A1.75 1.75.0 009.917 3.5zm11.666 2.333a1.75 1.75.0 10-3.501.001 1.75 1.75.0 003.501-.001zm1.75.0a3.502 3.502.0 01-1.75 3.026c-.055 6.581-4.721 8.039-7.82 9.023-2.898.911-3.846 1.349-3.846 3.117v.474a3.502 3.502.0 011.75 3.026c0 1.932-1.568 3.5-3.5 3.5s-3.5-1.568-3.5-3.5c0-1.294.711-2.424 1.75-3.026V6.526A3.502 3.502.0 014.667 3.5c0-1.932 1.568-3.5 3.5-3.5s3.5 1.568 3.5 3.5a3.502 3.502.0 01-1.75 3.026v9.06c.93-.456 1.914-.766 2.807-1.039 3.391-1.075 5.323-1.878 5.359-5.687a3.502 3.502.0 01-1.75-3.026c0-1.932 1.568-3.5 3.5-3.5s3.5 1.568 3.5 3.5z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="contacts" xmlns="http://www.w3.org/2000/svg"><path d="M22.688 22.688v-2q0-1.5-2.281-2.438t-4.406-.938-4.406.938-2.281 2.438v2h13.375zM16 9q-1.25.0-2.125.875T13 12t.875 2.125T16 15t2.125-.875T19 12t-.875-2.125T16 9zm10.688-3.687q1.063.0 1.844.813t.781 1.875v16q0 1.063-.781 1.875t-1.844.813H5.313q-1.063.0-1.844-.813t-.781-1.875v-16q0-1.063.781-1.875t1.844-.813h21.375zM5.313 32v-2.688h21.375V32H5.313zM26.688.0v2.688H5.313V0h21.375z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="create" xmlns="http://www.w3.org/2000/svg"><path d="M31.499 7.167l-3.25 3.25-6.666-6.666 3.25-3.25q.5-.5 1.25-.5t1.25.5l4.166 4.166q.5.5.5 1.25t-.5 1.25zM.001 25.333 19.667 5.667l6.666 6.666L6.667 31.999H.001v-6.666z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="date" xmlns="http://www.w3.org/2000/svg"><path d="M27.192 28.844V11.192H4.808v17.652h22.384zm0-25.689q1.277.0 2.253.976t.976 2.253v22.459q0 1.277-.976 2.216t-2.253.939H4.808q-1.352.0-2.291-.901t-.939-2.253V6.385q0-1.277.939-2.253t2.291-.976h1.577V.001h3.23v3.155h12.769V.001h3.23v3.155h1.577zm-3.155 11.267v3.155h-3.23v-3.155h3.23zm-6.46.0v3.155h-3.155v-3.155h3.155zm-6.384.0v3.155h-3.23v-3.155h3.23z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="download" xmlns="http://www.w3.org/2000/svg"><path d="M2.866 28.209h26.269v3.79H2.866v-3.79zm26.268-16.925L16 24.418 2.866 11.284h7.493V.001h11.283v11.283h7.493z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="email" xmlns="http://www.w3.org/2000/svg"><path d="M28.845 9.615v-3.23L16 14.422 3.155 6.385v3.23L16 17.577zm0-6.46q1.277.0 2.216.977T32 6.385v19.23q0 1.277-.939 2.253t-2.216.977H3.155q-1.277.0-2.216-.977T0 25.615V6.385q0-1.277.939-2.253t2.216-.977h25.69z"/></symbol><symbol viewBox="-7.27 -7.27 42.55 42.55" id="git" xmlns="http://www.w3.org/2000/svg"><path d="M27.472 12.753 15.247.529a1.803 1.803.0 00-2.55.0l-2.84 2.84 2.137 2.137a2.625 2.625.0 013.501 3.501l3.499 3.499a2.625 2.625.0 11-1.237 1.237l-3.499-3.499c-.083.04-.169.075-.257.106v7.3a2.626 2.626.0 11-1.75.0v-7.3a2.626 2.626.0 01-1.494-3.607L8.62 4.606l-8.09 8.09a1.805 1.805.0 000 2.551l12.225 12.224a1.803 1.803.0 002.55.0l12.168-12.168a1.805 1.805.0 000-2.551z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="github" xmlns="http://www.w3.org/2000/svg"><path d="M16 .394c8.833.0 15.999 7.166 15.999 15.999.0 7.062-4.583 13.062-10.937 15.187-.813.146-1.104-.354-1.104-.771.0-.521.021-2.25.021-4.396.0-1.5-.5-2.458-1.083-2.958 3.562-.396 7.312-1.75 7.312-7.896.0-1.75-.625-3.167-1.646-4.291.167-.417.708-2.042-.167-4.25-1.333-.417-4.396 1.646-4.396 1.646a15.032 15.032.0 00-8 0S8.937 6.602 7.603 7.018c-.875 2.208-.333 3.833-.167 4.25-1.021 1.125-1.646 2.542-1.646 4.291.0 6.125 3.729 7.5 7.291 7.896-.458.417-.875 1.125-1.021 2.146-.917.417-3.25 1.125-4.646-1.333-.875-1.521-2.458-1.646-2.458-1.646-1.562-.021-.104.979-.104.979 1.042.479 1.771 2.333 1.771 2.333.938 2.854 5.396 1.896 5.396 1.896.0 1.333.021 2.583.021 2.979.0.417-.292.917-1.104.771C4.582 29.455-.001 23.455-.001 16.393-.001 7.56 7.165.394 15.998.394zM6.063 23.372c.042-.083-.021-.187-.146-.25-.125-.042-.229-.021-.271.042-.042.083.021.187.146.25.104.062.229.042.271-.042zm.646.709c.083-.062.062-.208-.042-.333-.104-.104-.25-.146-.333-.062-.083.062-.062.208.042.333.104.104.25.146.333.062zm.625.937c.104-.083.104-.25.0-.396-.083-.146-.25-.208-.354-.125-.104.062-.104.229.0.375s.271.208.354.146zm.875.875c.083-.083.042-.271-.083-.396-.146-.146-.333-.167-.417-.062-.104.083-.062.271.083.396.146.146.333.167.417.062zm1.187.521c.042-.125-.083-.271-.271-.333-.167-.042-.354.021-.396.146s.083.271.271.312c.167.062.354.0.396-.125zm1.313.104c0-.146-.167-.25-.354-.229-.187.0-.333.104-.333.229.0.146.146.25.354.229.187.0.333-.104.333-.229zm1.208-.208c-.021-.125-.187-.208-.375-.187-.187.042-.312.167-.292.312.021.125.187.208.375.167s.312-.167.292-.292z"/></symbol><symbol viewBox="-7.27 -7.27 42.55 42.55" id="gitlab" xmlns="http://www.w3.org/2000/svg"><path d="M1.629 11.034 14 26.888.442 17.048a1.09 1.09.0 01-.39-1.203l1.578-4.811zm7.217.0h10.309l-5.154 15.854zM5.753 1.475l3.093 9.559H1.63l3.093-9.559a.548.548.0 011.031.0zm20.618 9.559 1.578 4.811c.141.437-.016.922-.39 1.203l-13.558 9.84 12.371-15.854zm0 0h-7.216l3.093-9.559a.548.548.0 011.031.0z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="heart" xmlns="http://www.w3.org/2000/svg"><path d="M16 29.714a1.11 1.11.0 01-.786-.321L4.072 18.643c-.143-.125-4.071-3.714-4.071-8 0-5.232 3.196-8.357 8.535-8.357 3.125.0 6.053 2.464 7.464 3.857 1.411-1.393 4.339-3.857 7.464-3.857 5.339.0 8.535 3.125 8.535 8.357.0 4.286-3.928 7.875-4.089 8.035L16.785 29.392c-.214.214-.5.321-.786.321z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="keyborad_arrow_left" xmlns="http://www.w3.org/2000/svg"><path d="M25.875 28.25 22.125 32 6.126 16.001 22.125.002l3.75 3.75-12.25 12.25z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="keyborad_arrow_right" xmlns="http://www.w3.org/2000/svg"><path d="M6.125 28.25 18.375 16 6.125 3.75 9.875.0l15.999 15.999L9.875 31.998z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="link" xmlns="http://www.w3.org/2000/svg"><path d="M24.037 7.963q3.305.0 5.634 2.366T32 16t-2.329 5.671-5.634 2.366h-6.46v-3.08h6.46q2.028.0 3.493-1.465t1.465-3.493-1.465-3.493-3.493-1.465h-6.46v-3.08h6.46zM9.615 17.578v-3.155h12.77v3.155H9.615zM3.005 16q0 2.028 1.465 3.493t3.493 1.465h6.46v3.08h-6.46q-3.305.0-5.634-2.366T0 16.001t2.329-5.671 5.634-2.366h6.46v3.08h-6.46q-2.028.0-3.493 1.465t-1.465 3.493z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="menu" xmlns="http://www.w3.org/2000/svg"><path d="M.001 5.334h31.998v3.583H.001V5.334zm0 12.416v-3.5h31.998v3.5H.001zm0 8.916v-3.583h31.998v3.583H.001z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="notifications" xmlns="http://www.w3.org/2000/svg"><path d="M25.846 22.154l3.308 3.308v1.615H2.847v-1.615l3.308-3.308V14q0-3.846 1.961-6.692t5.423-3.692V2.462q0-1 .692-1.731T16 0t1.769.731.692 1.731v1.154q3.461.846 5.423 3.692T25.846 14v8.154zM16 32q-1.385.0-2.346-.923t-.962-2.308h6.615q0 1.308-1 2.269T15.999 32z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="person" xmlns="http://www.w3.org/2000/svg"><path d="M16 20.023q5.052.0 10.526 2.199t5.473 5.754v4.023H0v-4.023q0-3.555 5.473-5.754t10.526-2.199zM16 16q-3.275.0-5.614-2.339T8.047 8.047t2.339-5.661T16 0t5.614 2.386 2.339 5.661-2.339 5.614T16 16z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="pin" xmlns="http://www.w3.org/2000/svg"><path d="M17.6 19.2h9.6v-1.6L22.4 16V3.2l4.8-1.6V0H4.8v1.6l4.8 1.6V16l-4.8 1.6v1.6h9.6v11.2L16 32l1.6-1.6V19.2z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="rss_feed" xmlns="http://www.w3.org/2000/svg"><path d="M-.481 12.048q8.482.0 14.457 5.976t5.976 14.457h-5.879q0-5.976-4.289-10.264T-.48 17.928v-5.879zm0-11.565q13.204.0 22.601 9.397t9.397 22.601h-5.783q0-10.891-7.662-18.553T-.481 6.266V.483zm0 27.468q0-1.831 1.301-3.132t3.229-1.301 3.181 1.253 1.253 3.181-1.301 3.229-3.132 1.301q-1.928.0-3.229-1.301T-.48 27.952z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="search" xmlns="http://www.w3.org/2000/svg"><path d="M11.925 20.161q3.432.0 5.834-2.402t2.402-5.834-2.402-5.834-5.834-2.402-5.834 2.402-2.402 5.834 2.402 5.834 5.834 2.402zm10.981.0L32 29.255 29.255 32l-9.094-9.094v-1.458l-.515-.515q-3.26 2.831-7.721 2.831-4.976.0-8.45-3.432T.001 11.925t3.474-8.45 8.45-3.474 8.407 3.474 3.432 8.45q0 1.802-.858 4.075t-1.973 3.646l.515.515h1.458z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="security" xmlns="http://www.w3.org/2000/svg"><path d="M16 0l13.072 5.855v8.715q0 6.059-3.745 11.063T16 31.999q-5.583-1.362-9.327-6.366T2.928 14.57V5.855zm0 16v13.004q4.017-1.294 6.808-4.868T26.144 16H16zm0 0V3.2L5.856 7.693v8.306H16z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="telescope" xmlns="http://www.w3.org/2000/svg"><path d="M25.026 3.335a.466.466.0 00-.646-.238L13.362 8.91a.463.463.0 00-.216.575l.227.593-6.36 3.488a.462.462.0 00-.205.583l.211.508-6.755 3.228a.463.463.0 00-.228.595l1.386 3.341a.463.463.0 00.583.259l7.056-2.5.211.508a.462.462.0 00.557.267l6.733-1.941.202.527a.46.46.0 00.566.277l12.03-3.702a.46.46.0 00.293-.613L25.026 3.335zM2.109 21.061l-1.049-2.53 6.314-3.018 1.332 3.211-6.596 2.337zm7.857-1.708-.22-.531-1.706-4.113-.22-.53 5.863-3.216 2.197 5.676.347.908-6.261 1.806zm7.505-1.146-.188-.491c-.003-.01-.001-.022-.006-.032l-.572-1.478-2.549-6.668 10.201-5.381 4.249 10.624-11.136 3.428zm8.943-16.723a.463.463.0 00-.86.344l5.552 13.881a.464.464.0 00.602.258.464.464.0 00.258-.602L26.413 1.484zM16.268 20.627h-2.776c-1.055.0-1.851.796-1.851 1.851v1.217l-5.44 6.347a.462.462.0 10.702.602l5.415-6.316h2.101v6.015a.463.463.0 00.926.0v-6.015h2.101l5.414 6.316a.462.462.0 10.703-.602l-5.44-6.347v-1.148c0-1.076-.813-1.92-1.851-1.92zm.925 2.777h-4.627v-.925c0-.545.38-.925.925-.925h2.776c.527.0.925.428.925.995v.856z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="timer" xmlns="http://www.w3.org/2000/svg"><path d="M16 29q4.428.0 7.536-3.143t3.107-7.571-3.107-7.536T16 7.643 8.464 10.75t-3.107 7.536 3.107 7.571T16 29zM26.714 9.786q1.214 1.571 2.107 4.036t.893 4.464q0 5.643-4 9.678T16 32t-9.714-4.036-4-9.678 4-9.678T16 4.572q1.929.0 4.464.929t4.107 2.143l2.143-2.214q1.143.929 2.143 2.143zM14.5 19.857v-9.143h3v9.143h-3zM20.571.001v3.071h-9.143V.001h9.143z"/></symbol><symbol viewBox="-7.27 -7.27 46.55 46.55" id="tree" xmlns="http://www.w3.org/2000/svg"><path d="M32 14.423H20.808V9.616h-3.23v12.77h3.23v-4.807H32v12.845H20.808v-4.807h-6.385v-16h-3.23v4.807H.001V1.579h11.192v4.807h9.615V1.579H32v12.845z"/></symbol></svg><svg style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><symbol viewBox="0 0 407 512" id="raspberry-pi" xmlns="http://www.w3.org/2000/svg"><path d="M372 232.5l-3.7-6.5c.1-46.4-21.4-65.3-46.5-79.7 7.6-2 15.4-3.6 17.6-13.2 13.1-3.3 15.8-9.4 17.1-15.8 3.4-2.3 14.8-8.7 13.6-19.7 6.4-4.4 10-10.1 8.1-18.1 6.9-7.5 8.7-13.7 5.8-19.4 8.3-10.3 4.6-15.6 1.1-20.9 6.2-11.2.7-23.2-16.6-21.2-6.9-10.1-21.9-7.8-24.2-7.8-2.6-3.2-6-6-16.5-4.7-6.8-6.1-14.4-5-22.3-2.1-9.3-7.3-15.5-1.4-22.6.8C271.6.6 269 5.5 263.5 7.6c-12.3-2.6-16.1 3-22 8.9l-6.9-.1c-18.6 10.8-27.8 32.8-31.1 44.1-3.3-11.3-12.5-33.3-31.1-44.1l-6.9.1c-5.9-5.9-9.7-11.5-22-8.9-5.6-2-8.1-7-19.4-3.4-4.6-1.4-8.9-4.4-13.9-4.3-2.6.1-5.5 1-8.7 3.5-7.9-3-15.5-4-22.3 2.1-10.5-1.3-14 1.4-16.5 4.7-2.3.0-17.3-2.3-24.2 7.8C21.2 16 15.8 28 22 39.2c-3.5 5.4-7.2 10.7 1.1 20.9-2.9 5.7-1.1 11.9 5.8 19.4-1.8 8 1.8 13.7 8.1 18.1-1.2 11 10.2 17.4 13.6 19.7 1.3 6.4 4 12.4 17.1 15.8 2.2 9.5 10 11.2 17.6 13.2-25.1 14.4-46.6 33.3-46.5 79.7l-3.7 6.5c-28.8 17.2-54.7 72.7-14.2 117.7 2.6 14.1 7.1 24.2 11 35.4 5.9 45.2 44.5 66.3 54.6 68.8 14.9 11.2 30.8 21.8 52.2 29.2C159 504.2 181 512 203 512h1c22.1.0 44-7.8 64.2-28.4 21.5-7.4 37.3-18 52.2-29.2 10.2-2.5 48.7-23.6 54.6-68.8 3.9-11.2 8.4-21.3 11-35.4 40.6-45.1 14.7-100.5-14-117.7zm-22.2-8c-1.5 18.7-98.9-65.1-82.1-67.9 45.7-7.5 83.6 19.2 82.1 67.9zm-43 93.1c-24.5 15.8-59.8 5.6-78.8-22.8s-14.6-64.2 9.9-80 59.8-5.6 78.8 22.8 14.6 64.2-9.9 80zM238.9 29.3c.8 4.2 1.8 6.8 2.9 7.6 5.4-5.8 9.8-11.7 16.8-17.3.0 3.3-1.7 6.8 2.5 9.4 3.7-5 8.8-9.5 15.5-13.3-3.2 5.6-.6 7.3 1.2 9.6 5.1-4.4 10-8.8 19.4-12.3-2.6 3.1-6.2 6.2-2.4 9.8 5.3-3.3 10.6-6.6 23.1-8.9-2.8 3.1-8.7 6.3-5.1 9.4 6.6-2.5 14-4.4 22.1-5.4-3.9 3.2-7.1 6.3-3.9 8.8 7.1-2.2 16.9-5.1 26.4-2.6l-6 6.1c-.7.8 14.1.6 23.9.8-3.6 5-7.2 9.7-9.3 18.2 1 1 5.8.4 10.4.0-4.7 9.9-12.8 12.3-14.7 16.6 2.9 2.2 6.8 1.6 11.2.1-3.4 6.9-10.4 11.7-16 17.3 1.4 1 3.9 1.6 9.7.9-5.2 5.5-11.4 10.5-18.8 15 1.3 1.5 5.8 1.5 10 1.6-6.7 6.5-15.3 9.9-23.4 14.2 4 2.7 6.9 2.1 10 2.1-5.7 4.7-15.4 7.1-24.4 10 1.7 2.7 3.4 3.4 7.1 4.1-9.5 5.3-23.2 2.9-27 5.6.9 2.7 3.6 4.4 6.7 5.8-15.4.9-57.3-.6-65.4-32.3 15.7-17.3 44.4-37.5 93.7-62.6-38.4 12.8-73 30-102 53.5-34.3-15.9-10.8-55.9 5.8-71.8zm-34.4 114.6c24.2-.3 54.1 17.8 54 34.7-.1 15-21 27.1-53.8 26.9-32.1-.4-53.7-15.2-53.6-29.8.0-11.9 26.2-32.5 53.4-31.8zm-123-12.8c3.7-.7 5.4-1.5 7.1-4.1-9-2.8-18.7-5.3-24.4-10 3.1.0 6 .7 10-2.1-8.1-4.3-16.7-7.7-23.4-14.2 4.2-.1 8.7.0 10-1.6-7.4-4.5-13.6-9.5-18.8-15 5.8.7 8.3.1 9.7-.9-5.6-5.6-12.7-10.4-16-17.3 4.3 1.5 8.3 2 11.2-.1-1.9-4.2-10-6.7-14.7-16.6 4.6.4 9.4 1 10.4.0-2.1-8.5-5.8-13.3-9.3-18.2 9.8-.1 24.6.0 23.9-.8l-6-6.1c9.5-2.5 19.3.4 26.4 2.6 3.2-2.5-.1-5.6-3.9-8.8 8.1 1.1 15.4 2.9 22.1 5.4 3.5-3.1-2.3-6.3-5.1-9.4 12.5 2.3 17.8 5.6 23.1 8.9 3.8-3.6.2-6.7-2.4-9.8 9.4 3.4 14.3 7.9 19.4 12.3 1.7-2.3 4.4-4 1.2-9.6 6.7 3.8 11.8 8.3 15.5 13.3 4.1-2.6 2.5-6.2 2.5-9.4 7 5.6 11.4 11.5 16.8 17.3 1.1-.8 2-3.4 2.9-7.6 16.6 15.9 40.1 55.9 6 71.8-29-23.5-63.6-40.7-102-53.5 49.3 25 78 45.3 93.7 62.6-8 31.8-50 33.2-65.4 32.3 3.1-1.4 5.8-3.2 6.7-5.8-4-2.8-17.6-.4-27.2-5.6zm60.1 24.1c16.8 2.8-80.6 86.5-82.1 67.9-1.5-48.7 36.5-75.5 82.1-67.9zM38.2 342c-23.7-18.8-31.3-73.7 12.6-98.3 26.5-7 9 107.8-12.6 98.3zm91 98.2c-13.3 7.9-45.8 4.7-68.8-27.9-15.5-27.4-13.5-55.2-2.6-63.4 16.3-9.8 41.5 3.4 60.9 25.6 16.9 20 24.6 55.3 10.5 65.7zm-26.4-119.7c-24.5-15.8-28.9-51.6-9.9-80s54.3-38.6 78.8-22.8 28.9 51.6 9.9 80c-19.1 28.4-54.4 38.6-78.8 22.8zM205 496c-29.4 1.2-58.2-23.7-57.8-32.3-.4-12.7 35.8-22.6 59.3-22 23.7-1 55.6 7.5 55.7 18.9.5 11-28.8 35.9-57.2 35.4zm58.9-124.9c.2 29.7-26.2 53.8-58.8 54-32.6.2-59.2-23.8-59.4-53.4v-.6c-.2-29.7 26.2-53.8 58.8-54s59.2 23.8 59.4 53.4v.6zm82.2 42.7c-25.3 34.6-59.6 35.9-72.3 26.3-13.3-12.4-3.2-50.9 15.1-72 20.9-23.3 43.3-38.5 58.9-26.6 10.5 10.3 16.7 49.1-1.7 72.3zm22.9-73.2c-21.5 9.4-39-105.3-12.6-98.3 43.9 24.7 36.3 79.6 12.6 98.3z"/><svg style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><symbol viewBox="0 0 24 24" id="kubernetes"><path d="M13.95 13.5h-.23c-.18.11-.26.32-.18.5l.86 2.11c.83-.53 1.46-1.32 1.79-2.25l-2.23-.36h-.01m-3.45.29a.415.415.0 00-.38-.29h-.08l-2.22.37c.33.92.96 1.7 1.79 2.23l.85-2.07V14c.04-.05.04-.14.04-.21m1.83.81a.378.378.0 00-.51-.15c-.07.05-.12.08-.15.15h-.01l-1.09 1.97c.78.26 1.62.31 2.43.12.14-.03.29-.07.43-.12l-1.09-1.97h-.01m3.45-4.57L14.1 11.5l.01.03a.37.37.0 00-.04.53c.05.06.11.1.18.12l.01.01 2.17.62c.07-.97-.14-1.95-.65-2.78m-3.11.16c.01.21.18.37.39.36.08.0.15-.02.21-.05h.01l1.83-1.31a4.45 4.45.0 00-2.57-1.24l.13 2.24m-1.94.31c.17.11.4.08.52-.09.05-.06.07-.13.08-.21h.01l.12-2.25c-.15.02-.3.05-.46.08-.8.18-1.54.58-2.12 1.16l1.84 1.31h.01m-.99 1.69c.2-.05.32-.26.26-.46.0-.08-.05-.14-.11-.19v-.01L8.21 10c-.52.86-.74 1.84-.63 2.82l2.16-.62v-.01m1.64.66.62.3.62-.3.15-.67-.43-.53h-.69l-.43.53.16.67m10.89 1.32L20.5 6.5c-.09-.42-.37-.76-.74-.94l-7.17-3.43c-.37-.17-.81-.17-1.19.0L4.24 5.56c-.37.18-.65.52-.74.94l-1.77 7.67c-.05.2-.05.4.0.59.01.06.03.12.05.18.03.09.08.19.13.27.03.04.05.08.09.11l4.95 6.18c.02.0.05.04.05.06.1.09.19.16.28.22.12.08.26.14.4.17.11.05.23.05.32.05h8.12c.07.0.14-.03.2-.05.05-.01.1-.03.14-.04.04-.02.07-.03.11-.05.05-.02.1-.05.15-.08.12-.08.23-.18.33-.28l.15-.2 4.8-5.98c.1-.12.17-.25.22-.38.02-.06.04-.12.05-.18.05-.19.05-.4.0-.59m-7.43 2.99c.02.06.04.12.07.17-.04.08-.06.17-.03.26.12.24.23.46.38.68.08.11.16.23.24.34.0.03.03.08.04.12.12.2.06.46-.15.59s-.47.05-.59-.15c-.01-.03-.02-.05-.03-.08-.02-.03-.04-.09-.06-.09-.05-.15-.09-.28-.12-.41-.09-.25-.17-.49-.3-.72a.375.375.0 00-.21-.14l-.08-.16c-1.29.48-2.7.48-3.97-.01l-.1.18c-.07.01-.14.04-.19.09-.14.24-.24.49-.33.77-.03.13-.07.26-.12.4-.02.0-.04.07-.06.1a.43.43.0 01-.81-.29c.01-.03.03-.05.04-.08.04-.03.04-.08.04-.11.09-.12.16-.23.24-.35.16-.21.29-.45.39-.69a.54.54.0 00-.03-.25l.07-.18a5.611 5.611.0 01-2.47-3.09l-.2.03a.388.388.0 00-.23-.09c-.27.05-.51.13-.77.22-.11.06-.24.11-.37.15-.03.01-.07.02-.13.03a.438.438.0 01-.54-.27c-.07-.23.04-.47.28-.55.02.0.05-.01.08-.01v-.01h.01l.11-.02c.14-.04.28-.04.41-.04.26.0.52-.06.77-.12.08-.05.14-.11.19-.19l.19-.05c-.21-1.36.1-2.73.86-3.87l-.14-.12c0-.09-.03-.18-.08-.25-.2-.17-.41-.32-.64-.45-.12-.06-.24-.13-.36-.21-.02-.02-.06-.05-.08-.07l-.01-.01c-.2-.16-.25-.42-.11-.63.09-.1.21-.15.35-.15.11.01.21.05.3.12l.09.07c.1.09.19.2.28.3.18.19.37.37.58.52.08.04.17.05.26.03l.15.11c.75-.8 1.73-1.36 2.8-1.6.25-.06.52-.1.78-.12l.01-.18a.45.45.0 00.14-.23c.01-.26-.01-.52-.05-.77-.03-.13-.05-.27-.06-.41V5.1c-.02-.24.15-.45.39-.48s.44.15.47.38v.22c-.01.14-.03.28-.06.41-.04.25-.06.51-.05.77.02.1.07.17.14.22l.01.19c1.36.12 2.62.73 3.56 1.72l.16-.12c.09.02.18.01.26-.03.21-.15.41-.33.58-.52.09-.1.18-.2.28-.3.03-.02.07-.06.1-.06.17-.18.44-.18.59.0.19.16.18.43.0.6.0.02-.03.04-.06.06a2.495 2.495.0 01-.44.28c-.23.13-.45.28-.64.45-.06.07-.09.15-.08.24l-.16.14a5.44 5.44.0 01.88 3.86l.19.05c.04.08.11.14.19.18.25.07.51.11.77.14h.41c.03.03.08.04.12.05.24.03.4.25.37.49-.05.23-.24.4-.48.37-.03-.01-.07-.01-.07-.02v-.01c-.06.0-.1-.01-.14-.02-.13-.04-.25-.09-.36-.15-.26-.1-.5-.17-.77-.21-.09.0-.17.0-.23.08-.07-.01-.13-.02-.19-.03-.41 1.31-1.31 2.41-2.47 3.11z" fill="#fff"/></svg><svg style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><symbol viewBox="0 0 24 24" id="home-assistant"><path d="M21.8 13H20v8h-7v-3.33l2.79-2.79.71.12a2.1 2.1.0 100-4.2 2.1 2.1.0 00-2.1 2.1l.1.71-1.5 1.52V9.65c.66-.36 1.1-1.05 1.1-1.85A2.1 2.1.0 0012 5.7 2.1 2.1.0 009.9 7.8c0 .8.44 1.49 1.1 1.85v5.48l-1.5-1.52.1-.71a2.1 2.1.0 00-2.1-2.1 2.1 2.1.0 00-2.1 2.1A2.1 2.1.0 007.5 15l.71-.12L11 17.67V21H4v-8H2.25c-.42.0-.83.0-.83-.21.01-.22.43-.64.86-1.07L11 3c.33-.33.67-.67 1-.67s.67.34 1 .67l4 4V6h2v3l2.78 2.78c.4.4.81.81.82 1.02.0.2-.4.2-.8.2M7.5 12a.9.9.0 01.9.9.9.9.0 01-.9.9.9.9.0 01-.9-.9.9.9.0 01.9-.9m9 0c.5.0.9.4.9.9s-.4.9-.9.9a.9.9.0 01-.9-.9.9.9.0 01.9-.9M12 6.9c.5.0.9.4.9.9s-.4.9-.9.9-.9-.4-.9-.9.4-.9.9-.9z" fill="#fff"/></svg><svg style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><symbol viewBox="0 0 512 512" id="home"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"/></svg><div class=wrapper><header class=gblog-header><div class="container flex align-center justify-center"><a class=gblog-header__link rel=me href=https://homeautomation.wiki><span class="gblog-brand flex align-center justify-center"><img class=gblog-brand__img src=/logo.png alt width=60 height=60>
HomeAutomation.wiki</span>
<span class="gblog-brand__subtitle flex align-center justify-center">Automation is my mantra!</span></a></div></header><nav class=gblog-nav><input type=checkbox id=menu-control class=hidden><div class=gblog-nav__control><label for=menu-control class="flex align-center justify-center"><svg class="icon menu"><use xlink:href="#menu"/></svg><svg class="icon clear"><use xlink:href="#clear"/></svg><span>Nav</span></label></div><ul class="gblog-nav__list container flex flex-wrap justify-center menu-content"><li><a href=/tags/kubernetes/ class=gblog-nav__entry><svg class="icon kubernetes"><use xlink:href="#kubernetes"/></svg>Kubernetes</a></li><li><a href=/tags/raspberry-pi class=gblog-nav__entry><svg class="icon raspberry-pi"><use xlink:href="#raspberry-pi"/></svg>Raspberry Pi</a></li><li><a href=/tags/home-assistant/ class=gblog-nav__entry><svg class="icon home-assistant"><use xlink:href="#home-assistant"/></svg>Home Assistant</a></li><li><a href=/about class=gblog-nav__entry><svg class="icon home"><use xlink:href="#home"/></svg>About Us</a></li><li><a href=https://github.com/homeautomation-wiki class=gblog-nav__entry><svg class="icon github"><use xlink:href="#github"/></svg>Github Profile</a></li></ul></nav><main class="gblog-page container"><article class=gblog-post><header class=gblog-post__header><h1>Kubernetes Homelab with K3S and Raspberry Pi 4</h1><div class=gblog-post__meta><span class=no-wrap><svg class="icon date"><use xlink:href="#date"/></svg><span class=gblog-post__tag><time datetime=2021-07-19T00:00:00Z>Jul 19, 2021</time></span></span>
<span class=no-wrap><svg class="icon timer"><use xlink:href="#timer"/></svg><span class=gblog-post__tag>15 min read</span></span></div></header><section class=gblog-markdown><div class=gblog-post__anchorwrap><h1 id=building-a-kubernetes-homelab-with-k3s-and-raspberry-pi-4-the-hard-way>Building A Kubernetes Homelab with K3S and Raspberry Pi 4: The Hard Way
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#building-a-kubernetes-homelab-with-k3s-and-raspberry-pi-4-the-hard-way class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Building A Kubernetes Homelab with K3S and Raspberry Pi 4: The Hard Way" href=#building-a-kubernetes-homelab-with-k3s-and-raspberry-pi-4-the-hard-way><svg class="icon link"><use xlink:href="#link"/></svg></a></h1></div><p>K3S is one of the best solutions available if you want to deploy your own Kubernetes cluster inside your homelab to play with, or just for learning purposes. And it is really easy to get started with a couple of (actually, you only need one) Raspberry PIs. But &ldquo;What is K3S?&rdquo;, you might ask. From their <a class=gblog-post__link href=https://rancher.com/docs/K3S/latest/en/>website</a>
;</p><pre><code>K3S - Lightweight Kubernetes

Lightweight Kubernetes. Easy to install, half the memory, all in a binary of less than 100 MB.

Great for:

Edge
IoT
CI
Development
ARM
Embedding K8s
Situations where a PhD in K8s clusterology is infeasible
</code></pre><p>Although that there are other ways to run Kubernetes with limited resources, I found K3S is the most expandable, upstream-compatible, tweakable, and production-ready alternative for full-fletch Kubernetes clusters deployed with <a class=gblog-post__link href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/>kubeadm</a>
or similar.</p><p>There are some fantastic tools available like <a class=gblog-post__link href=https://github.com/alexellis/k3sup>k3up</a>
to get you started with your cluster fairly quickly, but in this article, I will focus on how to do things, the hard way, with lots of references for advanced reading material as well.</p><p>So, buckle up and get ready because we are starting!</p><div class=gblog-post__anchorwrap><h2 id=k3s-basics>K3S Basics
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#k3s-basics class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor K3S Basics" href=#k3s-basics><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>The main components of K3S are called K3S server node(s) and K3S agent node(s). K3S server node(s) is responsible for managing the cluster, running SQLite or etcd, hosting the API Server, and act as a scheduler, as a regular Kubernetes master node. K3S Agent on the other hand is just like the regular Kubernetes worker nodes. You can find more information in the official <a class=gblog-post__link href=https://rancher.com/docs/k3s/latest/en/architecture/>K3S documantation</a>
.</p><p><img src=/images/k3s-the-hard-way/k3s-how-it-works.svg alt="K3S Architecture"><em>Diagram <a class=gblog-post__link href=https://k3s.io/>from k3s.io</a></em></p><p>You can have a single-node K3S server with an embedded SQLite database which will also act as an agent node, or, you can have a combination of server node(s) with one or more agent nodes to support different use-cases. K3S, by default, uses SQLite, Flannel, and Traefik Ingress Controller and comes with a local-path storage provisioner to handle stateful applications, therefore, it is a really good option to deploy on IoT devices, etc.</p><p>K3S can also be a great option for more advanced stuff as well because of its configurable nature. Only with some minor tweaks on default settings, we might end up with an almost production-ready Kubernetes environment, and in this article, we gonna do just that!</p><div class=gblog-post__anchorwrap><h3 id=honorable-mentions-alternatives>Honorable Mentions (Alternatives)
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#honorable-mentions-alternatives class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Honorable Mentions (Alternatives)" href=#honorable-mentions-alternatives><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><ul><li><a class=gblog-post__link href=https://k3d.io/>k3d</a></li><li><a class=gblog-post__link href=https://microk8s.io/>microk8s</a></li><li><a class=gblog-post__link href=https://minikube.sigs.k8s.io/docs/>minikube</a></li><li><a class=gblog-post__link href=https://kind.sigs.k8s.io/>kind</a></li></ul><div class=gblog-post__anchorwrap><h2 id=design>Design
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#design class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Design" href=#design><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>Although that I am generally happy with the default settings of K3S and 32-bit Raspberry Pi OS, I decided to spice up things by making some interesting design choices.</p><ol><li>64-bit Ubuntu 21.04 instead of 32-bit alternatives.</li><li>1 server (master+worker) + 2 agent (worker) nodes. I am planning to add 2 additional server nodes in the future to have an HA setup.</li><li>Keepalived cluster between K3S nodes.</li><li>Calico instead of Flannel (K3S default) as CNI.</li><li>Nginx Ingress instead of Traefik (K3S default) Ingress.</li><li>Etcd instead of SQLite (K3S default).</li><li>A VM with Ubuntu 21.04 x86-64 as <a class=gblog-post__link href=https://rancher.com/products/rancher/multi-cluster-management/>Rancher cluster manager</a>
to have a nice management UI (optional).</li><li><a class=gblog-post__link href=https://metallb.universe.tf/>MetalLB</a>
instead of <a class=gblog-post__link href=https://rancher.com/docs/K3S/latest/en/networking/#how-the-service-lb-works>servicelb</a>
(optional).</li><li><a class=gblog-post__link href=https://longhorn.io/>Longhorn</a>
as <strong>local</strong> distrubuted block storage and <a class=gblog-post__link href=https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/blob/master/charts/nfs-subdir-external-provisioner/README.md>NFS External Provisioner</a>
as CSI (optional).</li><li>Automatic SSL certificate management and renewals with <a class=gblog-post__link href=https://cert-manager.io/docs/>cert-manager</a>
(optional).</li></ol><p>so the final design will look something like this;</p><p><img src=/images/k3s-the-hard-way/k3s-design.png alt="K3S Cluster Desing"></p><p><em>Design Diagram of the RPI K3S Cluster</em></p><div class=gblog-post__anchorwrap><h2 id=requirements>Requirements
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#requirements class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Requirements" href=#requirements><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><div class=gblog-post__anchorwrap><h3 id=rancher-cluster-manager-optional>Rancher Cluster Manager (Optional)
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#rancher-cluster-manager-optional class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Rancher Cluster Manager (Optional)" href=#rancher-cluster-manager-optional><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>VM with Ubuntu 21.04 x86-64 (or your distribution of choice). I want this node to be x86-64 so that I can be more flexible in the future.</p><ul><li>2 CPU</li><li>4 GB RAM</li><li>25 GB Disk</li></ul><div class=gblog-post__anchorwrap><h3 id=raspberry-pi-4-k3s-cluster>Raspberry Pi 4 K3S Cluster
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#raspberry-pi-4-k3s-cluster class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Raspberry Pi 4 K3S Cluster" href=#raspberry-pi-4-k3s-cluster><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><ul><li>3 x Raspberry Pi 4 Model B 8GB (you need at least 1 node).</li><li>3 x Raspberry Pi 4 Model B PoE+ HAT (optional).</li><li>64 GB USB Stick (I am using USB sticks instead of SD cards).</li><li>A nice case that you can stack your PIs on (optional).</li></ul><p>In this guide, I will assume that you already have the OSs ready, so I will skip the OS installation details. But if you need to prepare your OS first, then check this great guide from <a class=gblog-post__link href=https://ubuntu.com/tutorials/how-to-install-ubuntu-desktop-on-raspberry-pi-4#1-overview>Ubuntu</a>
to get started.</p><div class=gblog-post__anchorwrap><h3 id=dns>DNS
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#dns class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor DNS" href=#dns><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>You need a domain name (such as home.lab). This could be internal or external (real).</p><ul><li>edith.home.lab 10.0.0.16 - VIP, for kube-api</li><li>edith01.home.lab 10.0.0.11 - K3S server node</li><li>edith02.home.lab 10.0.0.12 - K3S agent node</li><li>edith03.home.lab 10.0.0.13 - K3S agent node</li><li>*.K3S.home.lab 10.0.0.16 - A wildcard DNS for Ingress, pointing to VIP</li><li>rancher-admin.home.lab 10.0.0.17 - for Rancher cluster management UI (optional)</li></ul><div class=gblog-post__anchorwrap><h2 id=1-configuring-the-keepalived-cluster>1) Configuring the Keepalived Cluster
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#1-configuring-the-keepalived-cluster class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 1) Configuring the Keepalived Cluster" href=#1-configuring-the-keepalived-cluster><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>We will first start with configuring the Keepalived between our K3S nodes (PIs) to set the Virtual IP (VIP).</p><p>&ldquo;Why do we need this?&rdquo;, you might ask. Kubernetes API server exposes port 6443 to communicate with external clients, such as <code>kubectl</code> or our Rancher management node. But if you have multiple K3S server nodes, then you need a LoadBalancer on top to distribute the incoming traffic across the nodes and have protection for outages on one of your server (master) nodes.</p><p><img src=/images/k3s-the-hard-way/k3s-example-lb.jpg alt="Example K3S cluster design"><em>Example Diagram <a class=gblog-post__link href=https://rancher.com/blog/2020/K3S-high-availability>from Rancher Blog, written by ALEX ELLIS</a></em></p><p>In addition to that, you also need LoadBalancer to balance your ingress traffic between your agent (worker) nodes to access your services. Therefore, we need an external LoadBalancer on top of our cluster, or, we can use Keepalived to share the VIP address between the RPI nodes.</p><p>In order to install Keepalived, you need to run;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo apt-get install keepalived
</code></pre></div><p>on each of your K3S nodes (edith01, edith02, and edith03 for my case). After the installation, we need to configure keepalived to dedicate an IP as VIP and set the priority between our nodes before starting the service. I will use <code>10.0.0.15</code> as the VIP.</p><p><code>vi /etc/keepalived/keepalived.conf</code></p><p>You can see the example configs for primary and the secondary nodes below;</p><pre><code class=language-conf data-lang=conf>! Configuration File for keepalived primary node

global_defs {
   notification_email {
     sysadmin@home.lab
   }
   notification_email_from edith01@home.lab
   smtp_server localhost
   smtp_connect_timeout 30
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 101
    priority 102
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        10.0.0.15
    }
}
</code></pre><pre><code>! Configuration File for keepalived secondary

global_defs {
   notification_email {
     sysadmin@home.lab
   }
   notification_email_from edith02@home.lab
   smtp_server localhost
   smtp_connect_timeout 30
}

vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    virtual_router_id 101
    priority 101
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        10.0.0.15
    }
}
</code></pre><p>After changing the config in each node and setting the priority levels (primary - highest, secondary - lower) and the virtual_ipaddress, you can enable and start the keepalived service with;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo systemctl <span class=nb>enable</span> --now keepalived
</code></pre></div><p>You should see the VIP on your primary node when you run <code>ip addr show eth0</code></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class=m>1500</span> qdisc mq state UP group default qlen <span class=m>1000</span>
    link/ether dc:a6:32:ed:15:47 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.11/24 brd 10.0.30.255 scope global dynamic eth0
       valid_lft 84831sec preferred_lft 84831sec
    inet 10.0.0.15/32 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::dea6:32ff:feed:1547/64 scope link 
       valid_lft forever preferred_lft forever

</code></pre></div><p>and you can test the failover scenario by shutting down your primary node, just for fun :)</p><div class=gblog-post__anchorwrap><h2 id=2-enable-legacy-iptables-instead-of-nftables>2) Enable Legacy iptables instead of nftables
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#2-enable-legacy-iptables-instead-of-nftables class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 2) Enable Legacy iptables instead of nftables" href=#2-enable-legacy-iptables-instead-of-nftables><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>nftables is the successor to iptables and it replaces the existing iptables, ip6tables, arptables, and ebtables. If you are interested in the details, <a class=gblog-post__link href=https://wiki.gentoo.org/wiki/Nftables>check out this amazing article from Gentoo Wiki</a>
.
The newer versions of the most common Linux distributions, such as RHEL 8, CentOS 8, Debian Buster, Ubuntu 20.04, etc, already switched to nftables but <a class=gblog-post__link href=https://github.com/K3S-io/K3S/issues/1812>K3S does not support this yet</a>
.</p><p>Ubuntu 21.04 comes with nftables, by default. You can check your current backend with;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith02:~# iptables --version
iptables v1.8.7 <span class=o>(</span>nf_tables<span class=o>)</span>
</code></pre></div><p>In order to switch back to legacy iptables backend, run;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo update-alternatives --set iptables /usr/sbin/iptables-legacy
sudo update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy
</code></pre></div><p>then check your backend again,</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith02:~# iptables --version
iptables v1.8.7 <span class=o>(</span>legacy<span class=o>)</span>
</code></pre></div><p>and <code>reboot</code>. You need to do the same steps for all your nodes (obviously).</p><div class=gblog-post__anchorwrap><h2 id=3-enable-cgroups>3) Enable cgroups
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#3-enable-cgroups class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 3) Enable cgroups" href=#3-enable-cgroups><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>K3S needs cgroups to start the systemd service. cgroups can be enabled by appending <code>cgroup_memory=1 cgroup_enable=memory</code> to <code>/boot/cmdline.txt</code>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith03:~# cat /boot/cmdline.txt
<span class=nv>cgroup_memory</span><span class=o>=</span><span class=m>1</span> <span class=nv>cgroup_enable</span><span class=o>=</span>memory
</code></pre></div><p>and <code>reboot</code>. You need to do the same steps for all your nodes (obviously).</p><div class=gblog-post__anchorwrap><h2 id=4-deploying-the-k3s-cluster>4) Deploying the K3S Cluster
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#4-deploying-the-k3s-cluster class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 4) Deploying the K3S Cluster" href=#4-deploying-the-k3s-cluster><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>Deploying the K3S-server and K3S-agent nodes is pretty straightforward, especially if you want to stick with the default settings. But as I said in the previous chapter, I wanted to deploy my cluster with Calico instead of Flannel (K3S default) as CNI, Nginx Ingress instead of Traefik (K3S default) Ingress and etcd instead of SQLite, therefore, we will add some additional steps and flags to the default command.</p><div class=gblog-post__anchorwrap><h3 id=21-bootstrapping-the-server-node>2.1) Bootstrapping the Server Node
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#21-bootstrapping-the-server-node class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 2.1) Bootstrapping the Server Node" href=#21-bootstrapping-the-server-node><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>In order to use etcd in the HA mode, you must have an odd number of server node(s) and should deploy the cluster with <code>--cluster-init</code> flag. Although that I only do have one server node to start with, etcd should adjust itself and automatically upgrade into a cluster configuration when I add additional nodes in the future. In addition to that, I will also disable Traefik, Flannel and servicelb in order to use nginx-ingress, Calico and Metallb instead. I will also set <code>--cluster-cidr=192.168.0.0/16</code> and change the default value in order to deploy Calico without messing with the default Calico yaml files.</p><p>If you also want to check out other options as well, such as cluster-domain etc., you can see all of the configuration options from <a class=gblog-post__link href=https://rancher.com/docs/K3S/latest/en/installation/install-options/server-config/>here</a>
.</p><p>Before we deploy our server node with the desired config, we should create a server token. We will use this token in the future while we want to register our agents (and any other future nodes) into the cluster. I am using <a class=gblog-post__link href=https://www.base64encode.org/>an online base64 encoder to generate random string as a token</a>
, something like this;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith01:~# cat k3s-server-token 
<span class=nv>aHR0cHM6Ly9ob21lYXV0b21hdGlvbi53aWtpLw</span><span class=o>==</span>
</code></pre></div><p>And finally, deploy your server node with;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl -sfL https://get.K3S.io <span class=p>|</span> <span class=nv>K3S_TOKEN_FILE</span><span class=o>=</span>/root/k3s-server-token <span class=se>\
</span><span class=se></span><span class=nv>INSTALL_K3S_EXEC</span><span class=o>=</span><span class=s2>&#34;server --disable traefik --disable=servicelb --disable=traefik --flannel-backend=none --disable-network-policy --cluster-cidr=192.168.0.0/16&#34;</span> <span class=se>\
</span><span class=se></span>sh -s - --cluster-init --kube-apiserver-arg<span class=o>=</span>feature-gates<span class=o>=</span><span class=nv>RemoveSelfLink</span><span class=o>=</span><span class=nb>false</span> 
</code></pre></div><p>this might take ~2 minutes to complete.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith01:~# curl -sfL https://get.k3s.io <span class=p>|</span> <span class=nv>K3S_TOKEN_FILE</span><span class=o>=</span>/root/k3s-server-token <span class=se>\
</span><span class=se></span><span class=nv>INSTALL_K3S_EXEC</span><span class=o>=</span><span class=s2>&#34;server --disable traefik --disable=servicelb --disable=traefik --flannel-backend=none --disable-network-policy --cluster-cidr=192.168.0.0/16&#34;</span> <span class=se>\
</span><span class=se></span>sh -s - --cluster-init --kube-apiserver-arg<span class=o>=</span>feature-gates<span class=o>=</span><span class=nv>RemoveSelfLink</span><span class=o>=</span><span class=nb>false</span> 
<span class=o>[</span>INFO<span class=o>]</span>  Finding release <span class=k>for</span> channel stable
<span class=o>[</span>INFO<span class=o>]</span>  Using v1.21.2+k3s1 as release
<span class=o>[</span>INFO<span class=o>]</span>  Downloading <span class=nb>hash</span> https://github.com/k3s-io/k3s/releases/download/v1.21.2+k3s1/sha256sum-arm64.txt
<span class=o>[</span>INFO<span class=o>]</span>  Downloading binary https://github.com/k3s-io/k3s/releases/download/v1.21.2+k3s1/k3s-arm64
<span class=o>[</span>INFO<span class=o>]</span>  Verifying binary download
<span class=o>[</span>INFO<span class=o>]</span>  Installing k3s to /usr/local/bin/k3s
<span class=o>[</span>INFO<span class=o>]</span>  Creating /usr/local/bin/kubectl symlink to k3s
<span class=o>[</span>INFO<span class=o>]</span>  Creating /usr/local/bin/crictl symlink to k3s
<span class=o>[</span>INFO<span class=o>]</span>  Creating /usr/local/bin/ctr symlink to k3s
<span class=o>[</span>INFO<span class=o>]</span>  Creating killall script /usr/local/bin/k3s-killall.sh
<span class=o>[</span>INFO<span class=o>]</span>  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
<span class=o>[</span>INFO<span class=o>]</span>  env: Creating environment file /etc/systemd/system/k3s.service.env
<span class=o>[</span>INFO<span class=o>]</span>  systemd: Creating service file /etc/systemd/system/k3s.service
<span class=o>[</span>INFO<span class=o>]</span>  systemd: Enabling k3s unit
Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service → /etc/systemd/system/k3s.service.
<span class=o>[</span>INFO<span class=o>]</span>  systemd: Starting k3s
</code></pre></div><p>and you can check the status of k3s-server with;</p><pre><code>root@edith01:~# systemctl status k3s.service 
● k3s.service - Lightweight Kubernetes
     Loaded: loaded (/etc/systemd/system/k3s.service; enabled; vendor preset: enabled)
     Active: active (running) since Sat 2021-07-17 22:37:26 UTC; 5min ago
       Docs: https://k3s.io
    Process: 9982 ExecStartPre=/bin/sh -xc ! /usr/bin/systemctl is-enabled --quiet nm-cloud-setup.service (code=exited, status=0/SUCCESS)
    Process: 9984 ExecStartPre=/sbin/modprobe br_netfilter (code=exited, status=0/SUCCESS)
    Process: 9985 ExecStartPre=/sbin/modprobe overlay (code=exited, status=0/SUCCESS)
   Main PID: 9986 (k3s-server)
      Tasks: 32
     Memory: 665.9M
     CGroup: /system.slice/k3s.service
             ├─ 9986 /usr/local/bin/k3s server
             └─10002 containerd

</code></pre><p>and of course, you can check your K3S cluster (it will become a cluster in a few steps anyway) with <code>kubectl</code>;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith01:~# kubectl get nodes
NAME      STATUS   ROLES                       AGE   VERSION
edith01   Ready    control-plane,etcd,master   18m   v1.21.2+k3s1
</code></pre></div><p>If you want to delete & re-deploy, you can easily do that with running <code>k3s-uninstall.sh</code></p><pre><code>root@edith01:~# k3s-uninstall.sh 
+ id -u
+ [ 0 -eq 0 ]
+ /usr/local/bin/k3s-killall.sh
+ [ -s /etc/systemd/system/k3s.service ]
+ basename /etc/systemd/system/k3s.service
+ systemctl stop k3s.service
+ [ -x /etc/init.d/k3s* ]
+ killtree 3106 3213 3249 3284 3286
+ kill -9 3106 3159 3213 3239 3249 3314 3284 3345 3286 3338
+ do_unmount_and_remove /run/k3s
+ xargs -r -t -n 1 sh -c umount &quot;$0&quot; &amp;&amp; rm -rf &quot;$0&quot;
+ sort -r
+ awk -v path=/run/k3s $2 ~ (&quot;^&quot; path) { print $2 } /proc/self/mounts
.
.
.
+ type yum
+ remove_uninstall
+ rm -f /usr/local/bin/k3s-uninstall.sh
</code></pre><div class=gblog-post__anchorwrap><h3 id=22-deploying-calico-as-cni>2.2) Deploying Calico as CNI
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#22-deploying-calico-as-cni class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 2.2) Deploying Calico as CNI" href=#22-deploying-calico-as-cni><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>Before adding new nodes to our cluster, we should first install our CNI of choice, Calico, although that <a class=gblog-post__link href=https://rancher.com/docs/k3s/latest/en/installation/network-options/>you can also install something different</a>
, to the cluster in order to have the software-defined networking ready and available.</p><p>Calico is best known for its performance and network policy enforcement capabilities. I also experienced some weird DNS resolving issues with the Flannel overlay network and found out an open <a class=gblog-post__link href=https://github.com/k3s-io/k3s/issues/535>Github issue</a>
linked with it, and the only working solution was to use <code>--flannel-backend=host-gw</code> instead of default VXLAN backend, which I do not like. If you are interested in different CNIs, feel free to check <a class=gblog-post__link href=https://rancher.com/blog/2019/2019-03-21-comparing-kubernetes-cni-providers-flannel-calico-canal-and-weave/>this great article from Rancher Blog</a></p><p>In order to <a class=gblog-post__link href=https://docs.projectcalico.org/getting-started/kubernetes/k3s/multi-node-install>get started with Calico</a>
, you just need to run;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
</code></pre></div><p>this will create a couple of CRDs along with other things and a Daemonset which will run on each node. You can check your deployment status with;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith01:~# kubectl get ds -n kube-system
NAME          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
calico-node   <span class=m>1</span>         <span class=m>1</span>         <span class=m>1</span>       <span class=m>1</span>            <span class=m>1</span>           kubernetes.io/os<span class=o>=</span>linux   86m
</code></pre></div><p>If your Calico daemonset is in READY status, then you are also ready to proceed.</p><div class=gblog-post__anchorwrap><h3 id=23-bootstrapping-additional-server-nodes>2.3) Bootstrapping Additional Server Node(s)
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#23-bootstrapping-additional-server-nodes class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 2.3) Bootstrapping Additional Server Node(s)" href=#23-bootstrapping-additional-server-nodes><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>Although that I will not add additional server nodes to my cluster right now, you can easily achieve this by copying your node token from <code>/var/lib/rancher/k3s/server/node-token</code> on your first node;</p><pre><code>root@edith01:~# cat /var/lib/rancher/k3s/server/node-token
K108bd4b6fc55e1ce77bbc321d49d::server:aHR0cHM6Ly9ob21lYXV0b21hdGlvbi53aWtpLw==
</code></pre><p>then run this command on the node that you wanted it to add to the cluster;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith02:~# curl -sfL https://get.k3s.io <span class=p>|</span> <span class=nv>INSTALL_K3S_EXEC</span><span class=o>=</span><span class=s2>&#34; agent --server https://&lt;vip or domain name&gt;:6443 --token &lt;your-node-token&gt;&#34;</span> sh -s -
</code></pre></div><p>Dont forget to set <code>&lt;vip or domain name></code> and <code>&lt;your-node-token></code> fields it the above command. This might take ~2 minutes to complete.</p><p>You can check the status of your cluster with running;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith01:~# kubectl get nodes
NAME      STATUS     ROLES                       AGE   VERSION
edith01   Ready      control-plane,etcd,master   22m   v1.21.2+k3s1
edith02   Ready      control-plane,etcd,master   12s   v1.21.2+k3s1
</code></pre></div><p>on your first node. Repeat this step for each node that you want to add to the cluster. Agent nodes will have <code>control-plane,etcd,master</code> as their cluster role.</p><div class=gblog-post__anchorwrap><h3 id=24-bootstrapping-agent-nodes>2.4) Bootstrapping Agent Node(s)
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#24-bootstrapping-agent-nodes class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 2.4) Bootstrapping Agent Node(s)" href=#24-bootstrapping-agent-nodes><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>Deploying agent nodes are almost the same as the additional server nodes, except with a slight difference in the last command. Again, start with copying your node token from <code>/var/lib/rancher/k3s/server/node-token</code> on your first node;</p><pre><code>root@edith01:~# scp  /var/lib/rancher/k3s/server/node-token 
K108bd4b6fc55e1ce77bbc321d49d::server:aHR0cHM6Ly9ob21lYXV0b21hdGlvbi53aWtpLw==
</code></pre><p>then run this command on the node that you wanted it to add to the cluster;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith02:~# curl -sfL https://get.k3s.io <span class=p>|</span> <span class=nv>INSTALL_K3S_EXEC</span><span class=o>=</span><span class=s2>&#34; agent --server https://&lt;vip or domain name&gt;:6443 --token &lt;your-node-token&gt;&#34;</span> sh -s -
</code></pre></div><p>Dont forget to set <code>&lt;vip or domain name></code> and <code>&lt;your-node-token></code> fields it the above command. This might take ~2 minutes to complete.</p><p>You can check the status of your cluster with running;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith01:~# kubectl get nodes
NAME      STATUS     ROLES                       AGE   VERSION
edith01   Ready      control-plane,etcd,master   22m   v1.21.2+k3s1
edith02   Ready      &lt;none&gt;                      12s   v1.21.2+k3s1
</code></pre></div><p>on your first node. You might also want to check your pods as well;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith01:~# kubectl get pods -A 
NAMESPACE       NAME                                       READY   STATUS    RESTARTS   AGE
cattle-system   cattle-cluster-agent-77896486cd-f5pj4      1/1     Running   <span class=m>0</span>          44m
fleet-system    fleet-agent-d59db746-lvjmb                 1/1     Running   <span class=m>1</span>          65m
kube-system     calico-kube-controllers-78d6f96c7b-5bv72   1/1     Running   <span class=m>7</span>          44m
kube-system     calico-node-k5m75                          1/1     Running   <span class=m>1</span>          88m
kube-system     calico-node-mrsx5                          1/1     Running   <span class=m>0</span>          86m
kube-system     calico-node-n2m9c                          1/1     Running   <span class=m>1</span>          86m
kube-system     coredns-7448499f4d-m67mf                   1/1     Running   <span class=m>0</span>          44m
kube-system     local-path-provisioner-5ff76fc89d-flhxj    1/1     Running   <span class=m>0</span>          31m
kube-system     metrics-server-86cbb8457f-hz9s7            1/1     Running   <span class=m>0</span>          44m
</code></pre></div><p>Repeat this step for each node that you want to add to the cluster. Agent nodes will have <code>&lt;none></code> as their cluster role, this is normal.</p><div class=gblog-post__anchorwrap><h2 id=3-deploying-nginx-ingress-instead-of-traefik>3) Deploying Nginx-ingress instead of Traefik
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#3-deploying-nginx-ingress-instead-of-traefik class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor 3) Deploying Nginx-ingress instead of Traefik" href=#3-deploying-nginx-ingress-instead-of-traefik><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>Our cluster is ready to roll, except for an ingress controller to expose our services to the outside network. If you remember, we initiated <code>--disable traefik</code> flag to disable the default traefik ingress controller, during the initial deployment of the cluster. But if you did not, you can still disable traefik with changing the <code>/etc/systemd/system/k3s.service/k3s.service</code> file and add <code>--disable=traefik</code> flag.</p><pre><code class=language-config data-lang=config>ExecStart=/usr/local/bin/k3s \
    server \
        '--disable=servicelb' \
        '--disable=traefik' \
        '--flannel-backend=none' \
        '--cluster-init' \
        '--kube-apiserver-arg=feature-gates=RemoveSelfLink=false' \
</code></pre><p>then you can reload the configuration file with <code>systemctl daemon-reload</code> command and restart the service with <code>systemctl restart k3s.service</code>. This should automatically remove traefik from your cluster.</p><div class=gblog-post__anchorwrap><h3 id=installing-nginx-ingress-with-helm-charts>Installing Nginx-ingress with Helm Charts
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#installing-nginx-ingress-with-helm-charts class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor Installing Nginx-ingress with Helm Charts" href=#installing-nginx-ingress-with-helm-charts><svg class="icon link"><use xlink:href="#link"/></svg></a></h3></div><p>We will use the official nginx-ingress Helm Chart to install Nginx Ingress Controller and <a class=gblog-post__link href=https://www.suse.com/>I learned from our friends from SUSE</a>
that K3S has this nice feature that allows us to deploy Helm Charts by placing a yaml file under <code>/var/lib/rancher/k3s/server/manifests</code>.</p><p>I used this <a class=gblog-post__link href="https://www.suse.com/support/kb/doc/?id=000020082">knowlage base article from SUSE</a>
but while doing so, I realized that in their yaml file, the chart name and version are not written correctly. Therefore, we will change the commend slightly;</p><pre><code>cat &gt;/var/lib/rancher/k3s/server/manifests/ingress-nginx.yaml &lt;&lt;EOF
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-nginx
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: ingress-nginx
  namespace: kube-system
spec:
  chart: ingress-nginx
  repo: https://kubernetes.github.io/ingress-nginx
  targetNamespace: ingress-nginx
  set:
  valuesContent: |-
    fullnameOverride: ingress-nginx
    controller:
      kind: DaemonSet
      hostNetwork: true
      service:
        enabled: false
      publishService:
        enabled: false
      metrics:
        enabled: true
      config:
        use-forwarded-headers: &quot;true&quot;
EOF
</code></pre><p>This will automatically trigger K3S to deploy ingress-nginx Helm Chart in DaemonSet mode with <code>hostNetwork</code> enabled. You should see <code>helm-install-ingress-nginx-xxx</code> deployment being created under your <code>kube-system</code> namespace.</p><pre><code>root@edith01:~# kubectl get pods -n kube-system
NAME                                       READY   STATUS              RESTARTS   AGE
calico-kube-controllers-78d6f96c7b-5bv72   1/1     Running             7          45m
calico-node-k5m75                          1/1     Running             1          89m
calico-node-mrsx5                          1/1     Running             0          87m
calico-node-n2m9c                          1/1     Running             1          87m
coredns-7448499f4d-m67mf                   1/1     Running             0          45m
helm-install-ingress-nginx-j95pf           0/1     ContainerCreating   0          10s
local-path-provisioner-5ff76fc89d-flhxj    1/1     Running             0          33m
metrics-server-86cbb8457f-hz9s7            1/1     Running             0          45m
</code></pre><p>Enabling <code>hostNetwork</code> will ensure that our pods running in the cluster will use the network of the host they run and the NGINX Ingress controller will bind ports 80 and 443 directly. If you want to learn more about this or check any other alternatives, please check <a class=gblog-post__link href=https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#via-the-host-network>here</a>
.</p><p>You can check your deployment status with;</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>root@edith01:~# kubectl get pods -n ingress-nginx
NAME                             READY   STATUS    RESTARTS   AGE
ingress-nginx-controller-885js   1/1     Running   <span class=m>0</span>          4m13s
ingress-nginx-controller-vl6z8   1/1     Running   <span class=m>0</span>          4m13s
ingress-nginx-controller-wg47f   1/1     Running   <span class=m>0</span>          4m13s
</code></pre></div><p>and that&rsquo;s it. Now you have a K3S cluster ready with 3 nodes and with Calico instead of only Flannel (K3S default) as CNI, Nginx Ingress instead of Traefik (K3S default) Ingress and etcd instead of SQLite.</p><div class=gblog-post__anchorwrap><h2 id=to-the-future-and-beyond>To the Future and Beyond
<a data-clipboard-text=https://homeautomation.wiki/post/k3s-the-hard-way/#to-the-future-and-beyond class="gblog-post__anchor gblog-post__anchor--right clip" aria-label="Anchor To the Future and Beyond" href=#to-the-future-and-beyond><svg class="icon link"><use xlink:href="#link"/></svg></a></h2></div><p>From now on, we are ready to deploy and run stuff in our K3S cluster in Raspberry PIs and we finalized all of the steps, except the optional ones in my wishlist at <a class=gblog-post__link href=#design>Design</a>
chapter.</p><p>The optional points will make your cluster more expandable, especially with the CSI interfaces such as Longhorn, and will automate some painful stuff such as Let&rsquo;s Encrypt SSL certificate renewals and cluster management with Rancher GUI but they are not mandatory for your cluster to function, therefore I will be covering those topics under separate post.</p><p>See you next time!</p></section></article></main><footer class=gblog-footer><nav class=container><section class="flex flex-wrap align-center"></section><section class="flex flex-wrap align-center"><span class=gblog-footer__item>Built with <a href=https://gohugo.io/ class=gblog-footer__link>Hugo</a> and<svg class="icon heart"><use xlink:href="#heart"/></svg></span></section><section class="flex flex-wrap align-center"><span class=gblog-footer__item>Hosted on <a href=https://pages.github.com/ class=gblog-footer__link>GitHub Pages</a></span></section></nav></footer></div><script defer src=/js/clipboard-f06c52bfdd.min.js></script><script>document.addEventListener("DOMContentLoaded",function(a){var b=new ClipboardJS('.clip')})</script></body></html>